<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>OBAN AI</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

:root {
  --cyan: #00fff7;
  --pink: #ff006e;
  --yellow: #ffe600;
  --green: #00ff88;
  --bg: #050a0e;
  --bg2: #0a1628;
  --glass: rgba(0,255,247,0.04);
  --border: rgba(0,255,247,0.15);
}

html, body {
  height: 100%;
  width: 100%;
  overflow: hidden;
  background: var(--bg);
  color: var(--cyan);
  font-family: 'Share Tech Mono', monospace;
}

body {
  display: flex;
  flex-direction: column;
  position: relative;
}

/* Grid background */
.grid-bg {
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(0,255,247,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,255,247,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
  animation: gridMove 20s linear infinite;
  pointer-events: none;
  z-index: 0;
}

/* Scanlines */
.scanlines {
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.1) 2px, rgba(0,0,0,0.1) 4px);
  pointer-events: none;
  z-index: 1;
}

@keyframes gridMove { from { transform: translateY(0); } to { transform: translateY(40px); } }
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 15px var(--cyan); }
  50% { box-shadow: 0 0 30px var(--cyan), 0 0 60px rgba(0,255,247,0.3); }
}
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
@keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideLeft { from { opacity: 0; transform: translateX(-12px); } to { opacity: 1; transform: translateX(0); } }
@keyframes slideRight { from { opacity: 0; transform: translateX(12px); } to { opacity: 1; transform: translateX(0); } }
@keyframes typingDot { 0%, 100% { transform: translateY(0); opacity: 0.3; } 50% { transform: translateY(-5px); opacity: 1; } }
@keyframes micPulse { 0%, 100% { box-shadow: 0 0 8px rgba(255,0,110,0.4); } 50% { box-shadow: 0 0 22px rgba(255,0,110,0.8); } }
@keyframes wave { 0%, 100% { transform: scaleY(0.4); } 50% { transform: scaleY(1.2); } }

/* HEADER */
.header {
  position: relative;
  z-index: 10;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(0,255,247,0.05), transparent);
  flex-shrink: 0;
}

.logo-circle {
  width: 38px; height: 38px;
  border: 2px solid var(--cyan);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Orbitron', monospace;
  font-weight: 900; font-size: 15px;
  color: var(--cyan);
  animation: pulse 2s ease-in-out infinite;
  flex-shrink: 0;
}

.header-title { font-family: 'Orbitron', monospace; font-size: 18px; font-weight: 900; letter-spacing: 4px; color: var(--cyan); text-shadow: 0 0 20px var(--cyan); }
.header-status { font-size: 10px; color: var(--pink); letter-spacing: 2px; animation: blink 1.5s step-end infinite; margin-top: 2px; }
.header-right { margin-left: auto; text-align: right; font-size: 10px; color: rgba(0,255,247,0.35); line-height: 1.7; }

/* TICKER */
.ticker {
  position: relative; z-index: 10;
  display: flex; gap: 18px;
  padding: 5px 16px;
  border-bottom: 1px solid var(--border);
  background: rgba(0,255,247,0.02);
  overflow-x: auto;
  flex-shrink: 0;
}
.ticker::-webkit-scrollbar { display: none; }
.ticker-item { display: flex; align-items: center; gap: 5px; white-space: nowrap; cursor: pointer; font-size: 11px; }
.t-name { color: rgba(0,255,247,0.45); }
.t-price { color: var(--cyan); font-weight: bold; }
.t-up { color: var(--green); }
.t-down { color: var(--pink); }

/* CHAT */
.chat {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 14px;
  position: relative;
  z-index: 10;
  -webkit-overflow-scrolling: touch;
}
.chat::-webkit-scrollbar { width: 3px; }
.chat::-webkit-scrollbar-thumb { background: rgba(0,255,247,0.3); border-radius: 2px; }

/* Welcome */
.welcome { text-align: center; padding: 16px 0; animation: fadeUp 0.8s ease; }
.welcome h2 { font-family: 'Orbitron', monospace; font-size: 26px; font-weight: 900; letter-spacing: 6px; color: var(--cyan); text-shadow: 0 0 30px var(--cyan); margin-bottom: 6px; }
.welcome-sub { font-size: 10px; color: var(--pink); letter-spacing: 3px; margin-bottom: 12px; }
.welcome-line { height: 1px; background: linear-gradient(90deg, transparent, var(--cyan), transparent); margin: 10px 0; }
.welcome-desc { font-size: 11px; color: rgba(0,255,247,0.4); line-height: 1.9; letter-spacing: 0.5px; }
.quick-btns { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 14px; }
.qbtn {
  background: var(--glass);
  border: 1px solid var(--border);
  color: rgba(0,255,247,0.65);
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px; letter-spacing: 1px;
  padding: 7px 13px;
  border-radius: 2px;
  cursor: pointer;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.qbtn:active { background: rgba(0,255,247,0.12); border-color: var(--cyan); color: var(--cyan); }

/* Messages */
.msg { display: flex; flex-direction: column; gap: 3px; max-width: 86%; }
.msg.ai { align-self: flex-start; animation: slideLeft 0.25s ease; }
.msg.user { align-self: flex-end; align-items: flex-end; animation: slideRight 0.25s ease; }

.msg-label {
  font-size: 9px; letter-spacing: 2px; padding: 0 3px;
  display: flex; align-items: center; gap: 6px;
}
.msg.ai .msg-label { color: rgba(0,255,247,0.45); }
.msg.user .msg-label { color: rgba(255,0,110,0.5); }

.msg-bubble {
  padding: 11px 14px;
  font-size: 13px; line-height: 1.75;
  white-space: pre-wrap; word-break: break-word;
  border-radius: 2px;
}
.msg.ai .msg-bubble {
  background: var(--glass);
  border: 1px solid var(--border);
  border-left: 3px solid var(--cyan);
  color: rgba(0,255,247,0.88);
}
.msg.user .msg-bubble {
  background: rgba(255,0,110,0.07);
  border: 1px solid rgba(255,0,110,0.18);
  border-right: 3px solid var(--pink);
  color: rgba(255,200,215,0.88);
}

.speak-btn {
  background: none; border: none;
  color: rgba(0,255,247,0.35);
  font-size: 13px; cursor: pointer;
  padding: 0; line-height: 1;
  transition: color 0.2s;
}
.speak-btn:active, .speak-btn.on { color: var(--green); }

/* Typing indicator */
.typing-wrap { display: flex; flex-direction: column; gap: 3px; align-self: flex-start; animation: slideLeft 0.25s ease; }
.typing-label { font-size: 9px; letter-spacing: 2px; color: rgba(0,255,247,0.45); padding: 0 3px; }
.typing-dots {
  display: flex; align-items: center; gap: 7px;
  padding: 12px 16px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-left: 3px solid var(--cyan);
  width: fit-content;
}
.typing-dots span {
  width: 6px; height: 6px;
  background: var(--cyan); border-radius: 50%;
  animation: typingDot 1.1s ease-in-out infinite;
  box-shadow: 0 0 5px var(--cyan);
}
.typing-dots span:nth-child(2) { animation-delay: 0.18s; }
.typing-dots span:nth-child(3) { animation-delay: 0.36s; }
.typing-hint { font-size: 9px; color: rgba(0,255,247,0.35); margin-left: 8px; }

/* INPUT AREA */
.input-area {
  position: relative;
  z-index: 10;
  padding: 10px 14px 14px;
  border-top: 1px solid var(--border);
  background: linear-gradient(0deg, rgba(0,255,247,0.03), transparent);
  flex-shrink: 0;
}

.input-row {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 9px 11px;
  transition: border-color 0.25s;
}
.input-row:focus-within { border-color: rgba(0,255,247,0.5); }

.voice-wave {
  display: none;
  align-items: center;
  gap: 2px;
  height: 18px;
  flex-shrink: 0;
}
.voice-wave.on { display: flex; }
.voice-wave span {
  width: 3px; background: var(--pink); border-radius: 2px;
  animation: wave 0.55s ease-in-out infinite;
}
.voice-wave span:nth-child(1) { height: 7px; }
.voice-wave span:nth-child(2) { height: 14px; animation-delay: 0.1s; }
.voice-wave span:nth-child(3) { height: 10px; animation-delay: 0.2s; }
.voice-wave span:nth-child(4) { height: 16px; animation-delay: 0.15s; }
.voice-wave span:nth-child(5) { height: 7px; animation-delay: 0.05s; }

#msgInput {
  flex: 1;
  background: transparent;
  border: none; outline: none;
  color: var(--cyan);
  font-family: 'Share Tech Mono', monospace;
  font-size: 13px; line-height: 1.5;
  resize: none;
  min-height: 22px; max-height: 96px;
  overflow-y: auto;
}
#msgInput::placeholder { color: rgba(0,255,247,0.22); }

.btn-mic, .btn-send {
  width: 36px; height: 36px;
  border-radius: 3px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
  touch-action: manipulation;
}

.btn-mic {
  background: transparent;
  border: 1px solid rgba(0,255,247,0.25);
  color: rgba(0,255,247,0.5);
}
.btn-mic:active { background: rgba(0,255,247,0.08); }
.btn-mic.rec {
  border-color: var(--pink);
  color: var(--pink);
  animation: micPulse 0.7s ease-in-out infinite;
}

.btn-send {
  background: rgba(0,255,247,0.06);
  border: 1px solid var(--cyan);
  color: var(--cyan);
  box-shadow: 0 0 8px rgba(0,255,247,0.1);
}
.btn-send:active { background: rgba(0,255,247,0.15); box-shadow: 0 0 18px rgba(0,255,247,0.3); }
.btn-send:disabled { opacity: 0.3; pointer-events: none; }

.input-hint { font-size: 9px; color: rgba(0,255,247,0.18); letter-spacing: 0.8px; margin-top: 5px; }

/* SETUP SCREEN */
.setup {
  position: fixed; inset: 0;
  background: rgba(5,10,14,0.96);
  z-index: 200;
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
}
.setup-box {
  width: 100%; max-width: 340px;
  border: 1px solid var(--cyan);
  background: var(--bg2);
  padding: 28px 22px;
  box-shadow: 0 0 40px rgba(0,255,247,0.08);
  animation: fadeUp 0.4s ease;
}
.setup-tag { font-size: 9px; color: var(--pink); letter-spacing: 3px; margin-bottom: 14px; animation: blink 2s step-end infinite; }
.setup-box h2 { font-family: 'Orbitron', monospace; font-size: 17px; font-weight: 700; letter-spacing: 3px; color: var(--cyan); text-shadow: 0 0 18px var(--cyan); margin-bottom: 5px; }
.setup-box p { font-size: 11px; color: rgba(0,255,247,0.45); line-height: 1.7; margin-bottom: 4px; }
.setup-div { height: 1px; background: linear-gradient(90deg, transparent, var(--cyan), transparent); margin: 18px 0; }
.setup-box input {
  width: 100%;
  background: rgba(0,255,247,0.04);
  border: none; border-bottom: 2px solid var(--cyan);
  color: var(--cyan);
  font-family: 'Share Tech Mono', monospace;
  font-size: 12px; padding: 10px 10px;
  outline: none; margin-bottom: 16px;
  letter-spacing: 1px;
}
.setup-box input::placeholder { color: rgba(0,255,247,0.2); }
.setup-go {
  width: 100%;
  background: transparent;
  border: 1px solid var(--cyan);
  color: var(--cyan);
  font-family: 'Orbitron', monospace;
  font-size: 12px; font-weight: 700; letter-spacing: 3px;
  padding: 12px; cursor: pointer;
  transition: background 0.2s;
  touch-action: manipulation;
}
.setup-go:active { background: rgba(0,255,247,0.1); }
</style>
</head>
<body>

<div class="grid-bg"></div>
<div class="scanlines"></div>

<!-- SETUP -->
<div class="setup" id="setup">
  <div class="setup-box">
    <div class="setup-tag">‚óÜ SYSTEM INIT ‚óÜ</div>
    <h2>OBAN.AI</h2>
    <p>Masukkan Groq API Key untuk mengaktifkan sistem.</p>
    <p style="color:rgba(0,255,247,0.3);font-size:10px;">Daftar gratis di console.groq.com</p>
    <div class="setup-div"></div>
    <input type="password" id="keyInput" placeholder="gsk_xxxxxxxxxxxxxxxx" />
    <button class="setup-go" id="setupBtn">‚ñ∂ INISIALISASI SISTEM</button>
  </div>
</div>

<!-- HEADER -->
<div class="header">
  <div class="logo-circle">O</div>
  <div>
    <div class="header-title">OBAN</div>
    <div class="header-status" id="statusTxt">‚óè ONLINE // READY</div>
  </div>
  <div class="header-right">
    <div>SYS v5.1</div>
    <div style="color:rgba(255,230,0,0.45)">VOICE+CRYPTO</div>
  </div>
</div>

<!-- TICKER -->
<div class="ticker" id="ticker">
  <div class="ticker-item" style="color:rgba(0,255,247,0.25);font-size:10px;">‚ü≥ LOADING...</div>
</div>

<!-- CHAT -->
<div class="chat" id="chat">
</div>

<!-- INPUT -->
<div class="input-area">
  <div class="input-row">
    <div class="voice-wave" id="vWave">
      <span></span><span></span><span></span><span></span><span></span>
    </div>
    <textarea id="msgInput" placeholder="Ketik atau tekan üé§ untuk bicara..." rows="1"></textarea>
    <button class="btn-mic" id="micBtn">üé§</button>
    <button class="btn-send" id="sendBtn">‚ñ∂</button>
  </div>
  <div class="input-hint">ENTER = KIRIM &nbsp;|&nbsp; SHIFT+ENTER = BARIS BARU</div>
</div>

<script>
(function() {
  // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
  let apiKey = localStorage.getItem('oban_key') || '';
  let busy = false;
  let history = [];
  let cryptoCache = {};
  let recog = null;
  let recording = false;
  let speaking = false;

  // ‚îÄ‚îÄ ELEMENTS ‚îÄ‚îÄ
  const setupEl  = document.getElementById('setup');
  const setupBtn = document.getElementById('setupBtn');
  const keyInput = document.getElementById('keyInput');
  const chatEl   = document.getElementById('chat');
  const msgInput = document.getElementById('msgInput');
  const sendBtn  = document.getElementById('sendBtn');
  const micBtn   = document.getElementById('micBtn');
  const vWave    = document.getElementById('vWave');
  const statusTxt= document.getElementById('statusTxt');
  const ticker   = document.getElementById('ticker');

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
  if (apiKey) {
    setupEl.style.display = 'none';
    initRecog();
  }

  // ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ
  setupBtn.addEventListener('click', function() {
    const k = keyInput.value.trim();
    if (!k) return;
    apiKey = k;
    localStorage.setItem('oban_key', k);
    setupEl.style.display = 'none';
    initRecog();
    msgInput.focus();
  });

  keyInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') setupBtn.click();
  });

  // ‚îÄ‚îÄ TEXTAREA AUTO RESIZE ‚îÄ‚îÄ
  msgInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 96) + 'px';
  });

  msgInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      doSend();
    }
  });

  // ‚îÄ‚îÄ SEND BUTTON ‚îÄ‚îÄ
  sendBtn.addEventListener('click', function() {
    doSend();
  });

  // ‚îÄ‚îÄ MIC BUTTON ‚îÄ‚îÄ
  micBtn.addEventListener('click', function() {
    if (recording) stopRecog();
    else startRecog();
  });

  // ‚îÄ‚îÄ SPEECH RECOGNITION ‚îÄ‚îÄ
  function initRecog() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { micBtn.style.opacity = '0.2'; micBtn.title = 'Tidak didukung'; return; }
    recog = new SR();
    recog.lang = 'id-ID';
    recog.continuous = false;
    recog.interimResults = false;
    recog.onresult = function(e) {
      msgInput.value = e.results[0][0].transcript;
      msgInput.style.height = 'auto';
      msgInput.style.height = Math.min(msgInput.scrollHeight, 96) + 'px';
      stopRecog();
      doSend();
    };
    recog.onerror = stopRecog;
    recog.onend = stopRecog;
  }

  function startRecog() {
    if (!recog) return;
    recording = true;
    micBtn.classList.add('rec');
    micBtn.textContent = '‚èπ';
    vWave.classList.add('on');
    statusTxt.textContent = '‚óè LISTENING...';
    msgInput.placeholder = 'Mendengarkan...';
    try { recog.start(); } catch(e) { stopRecog(); }
  }

  function stopRecog() {
    recording = false;
    micBtn.classList.remove('rec');
    micBtn.textContent = 'üé§';
    vWave.classList.remove('on');
    statusTxt.textContent = '‚óè ONLINE // READY';
    msgInput.placeholder = 'Ketik atau tekan üé§ untuk bicara...';
    try { recog.stop(); } catch(e) {}
  }

  // ‚îÄ‚îÄ TEXT TO SPEECH ‚îÄ‚îÄ
  function speak(text) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    const clean = text.replace(/[‚óÜ‚ñ∂‚ö†*#_~`]/g, '').replace(/\n+/g, '. ').trim();
    const utt = new SpeechSynthesisUtterance(clean);
    utt.lang = 'id-ID';
    utt.rate = 1.0;
    utt.pitch = 1.0;
    const voices = window.speechSynthesis.getVoices();
    const idV = voices.find(v => v.lang.startsWith('id'));
    if (idV) utt.voice = idV;
    speaking = true;
    statusTxt.textContent = '‚óè SPEAKING...';
    utt.onend = utt.onerror = function() {
      speaking = false;
      statusTxt.textContent = '‚óè ONLINE // READY';
    };
    window.speechSynthesis.speak(utt);
  }

  function stopSpeak() {
    if (window.speechSynthesis) window.speechSynthesis.cancel();
    speaking = false;
    statusTxt.textContent = '‚óè ONLINE // READY';
  }

  // ‚îÄ‚îÄ CRYPTO ‚îÄ‚îÄ
  async function fetchTicker() {
    try {
      const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,binancecoin,ripple,hyperliquid&vs_currencies=usd&include_24hr_change=true');
      const d = await r.json();
      Object.assign(cryptoCache, d);
      renderTicker(d);
    } catch(e) {}
  }

  function renderTicker(d) {
    const map = {bitcoin:'BTC',ethereum:'ETH',solana:'SOL',binancecoin:'BNB',ripple:'XRP',hyperliquid:'HYPE'};
    ticker.innerHTML = '';
    for (const [id, sym] of Object.entries(map)) {
      if (!d[id]) continue;
      const p = d[id].usd, c = d[id].usd_24h_change;
      const ps = p >= 1 ? '$'+p.toLocaleString('en-US',{maximumFractionDigits:2}) : '$'+p.toFixed(5);
      const cls = c >= 0 ? 't-up' : 't-down';
      const sign = c >= 0 ? '+' : '';
      ticker.innerHTML += `<div class="ticker-item" onclick="quickAsk('Berapa harga ${sym} sekarang?')"><span class="t-name">${sym}</span><span class="t-price">${ps}</span><span class="${cls}">${sign}${c.toFixed(2)}%</span></div>`;
    }
  }

  async function searchCoin(q) {
    try {
      const r = await fetch(`https://api.coingecko.com/api/v3/search?query=${encodeURIComponent(q)}`);
      const d = await r.json();
      return d.coins && d.coins[0] ? d.coins[0].id : null;
    } catch(e) { return null; }
  }

  async function fetchPrices(ids) {
    try {
      const r = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids.join(',')}&vs_currencies=usd&include_24hr_change=true&include_market_cap=true`);
      return await r.json();
    } catch(e) { return {}; }
  }

  const STOP = new Set(['berapa','harga','sekarang','token','coin','crypto','nilai','info','tentang','dan','yang','di','ke','dari','untuk','adalah','ada','tolong','kasih','tahu','beri','hari','ini','saat','market','pasar','cek','lihat','tampilkan','top']);

  async function getCryptoContext(text) {
    const words = text.toLowerCase().replace(/[?!.,]/g,'').split(/\s+/).filter(w => w.length >= 2 && !STOP.has(w));
    if (!words.length) return '';

    // Try direct fetch first
    const direct = await fetchPrices(words.slice(0,3));
    const valid = {};
    for (const [id, v] of Object.entries(direct)) { if (v && v.usd) valid[id] = v; }

    // If nothing found, search
    if (!Object.keys(valid).length) {
      for (const w of words.slice(0,2)) {
        const id = await searchCoin(w);
        if (id) {
          const d = await fetchPrices([id]);
          if (d[id] && d[id].usd) { valid[id] = d[id]; break; }
        }
      }
    }

    if (!Object.keys(valid).length) return '';
    Object.assign(cryptoCache, valid);

    let ctx = '\n\n[DATA CRYPTO REALTIME ‚Äî ' + new Date().toLocaleString('id-ID') + ']\n';
    for (const [id, v] of Object.entries(valid)) {
      const p = v.usd, c = v.usd_24h_change, mc = v.usd_market_cap;
      const ps = p >= 1 ? '$'+p.toLocaleString('en-US',{maximumFractionDigits:2}) : '$'+p.toFixed(6);
      const mcs = mc ? ` | MCap $${(mc/1e9).toFixed(2)}B` : '';
      ctx += `${id}: ${ps} (24j: ${c>=0?'+':''}${c.toFixed(2)}%)${mcs}\n`;
    }
    return ctx;
  }

  function isCryptoQ(text) {
    const kw = ['harga','price','berapa','crypto','token','coin','bitcoin','ethereum','btc','eth','market','pasar','naik','turun'];
    return kw.some(k => text.toLowerCase().includes(k));
  }

  // ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ
  function addMsg(role, text) {
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + role;

    const lbl = document.createElement('div');
    lbl.className = 'msg-label';

    if (role === 'ai') {
      lbl.textContent = '‚óÜ OBAN';
      const sb = document.createElement('button');
      sb.className = 'speak-btn';
      sb.textContent = 'üîä';
      sb.addEventListener('click', function() {
        if (speaking) { stopSpeak(); sb.classList.remove('on'); }
        else { speak(text); sb.classList.add('on'); setTimeout(() => sb.classList.remove('on'), 500); }
      });
      lbl.appendChild(sb);
    } else {
      lbl.textContent = 'USER ‚óÜ';
    }

    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    bubble.textContent = text;

    wrap.appendChild(lbl);
    wrap.appendChild(bubble);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function showTyping(hint) {
    const wrap = document.createElement('div');
    wrap.className = 'typing-wrap';
    wrap.id = 'typing';

    const lbl = document.createElement('div');
    lbl.className = 'typing-label';
    lbl.textContent = '‚óÜ OBAN';

    const dots = document.createElement('div');
    dots.className = 'typing-dots';
    dots.innerHTML = '<span></span><span></span><span></span>';
    if (hint) {
      const h = document.createElement('span');
      h.className = 'typing-hint';
      h.textContent = hint;
      dots.appendChild(h);
    }

    wrap.appendChild(lbl);
    wrap.appendChild(dots);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function removeTyping() {
    const el = document.getElementById('typing');
    if (el) el.remove();
  }

  // ‚îÄ‚îÄ MAIN SEND ‚îÄ‚îÄ
  async function doSend() {
    if (busy) return;
    const text = msgInput.value.trim();
    if (!text) return;

    msgInput.value = '';
    msgInput.style.height = 'auto';
    busy = true;
    sendBtn.disabled = true;
    stopSpeak();

    addMsg('user', text);

    let ctx = '';
    if (isCryptoQ(text)) {
      showTyping('FETCHING CRYPTO DATA...');
      ctx = await getCryptoContext(text);
      removeTyping();
    }

    history.push({ role: 'user', content: text + ctx });
    showTyping();

    try {
      const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + apiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: 'llama-3.3-70b-versatile',
          max_tokens: 1024,
          messages: [
            { role: 'system', content: 'Kamu adalah OBAN, asisten AI pribadi yang cerdas dan ramah. Selalu jawab dalam Bahasa Indonesia yang natural. Jika ada data crypto realtime dalam pesan, gunakan untuk menjawab dengan akurat. Jawab ringkas dan jelas.' },
            ...history
          ]
        })
      });

      const data = await res.json();
      removeTyping();

      if (data.choices && data.choices[0]) {
        const reply = data.choices[0].message.content;
        history.push({ role: 'assistant', content: reply });
        addMsg('ai', reply);
        speak(reply);
      } else {
        const errMsg = '‚ö† ' + (data.error?.message || 'Gagal mendapat respons');
        addMsg('ai', errMsg);
      }
    } catch(e) {
      removeTyping();
      addMsg('ai', '‚ö† CONNECTION ERROR: Periksa koneksi internet Anda.');
    }

    busy = false;
    sendBtn.disabled = false;
    msgInput.focus();
  }

  // ‚îÄ‚îÄ GLOBAL quickAsk ‚îÄ‚îÄ
  window.quickAsk = function(text) {
    msgInput.value = text;
    msgInput.style.height = 'auto';
    msgInput.style.height = Math.min(msgInput.scrollHeight, 96) + 'px';
    doSend();
  };

  // ‚îÄ‚îÄ START ‚îÄ‚îÄ
  fetchTicker();
  setInterval(fetchTicker, 60000);

  // Load voices
  if (window.speechSynthesis) {
    window.speechSynthesis.getVoices();
    window.speechSynthesis.addEventListener('voiceschanged', function() {});
  }

})();
</script>
</body>
</html>
