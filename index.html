<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>OBAN AI</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
:root {
  --cyan: #00fff7;
  --pink: #ff006e;
  --green: #00ff88;
  --yellow: #ffe600;
  --bg: #050a0e;
  --bg2: #0a1628;
  --glass: rgba(0,255,247,0.04);
  --border: rgba(0,255,247,0.12);
}
html, body { height: 100%; width: 100%; overflow: hidden; background: var(--bg); color: var(--cyan); font-family: 'Share Tech Mono', monospace; }
body { display: flex; flex-direction: column; }

.grid-bg { position: fixed; inset: 0; background-image: linear-gradient(rgba(0,255,247,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,247,0.03) 1px, transparent 1px); background-size: 40px 40px; animation: gridMove 20s linear infinite; pointer-events: none; z-index: 0; }
.scanlines { position: fixed; inset: 0; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.1) 2px, rgba(0,0,0,0.1) 4px); pointer-events: none; z-index: 1; }

@keyframes gridMove { from { transform: translateY(0); } to { transform: translateY(40px); } }
@keyframes pulse { 0%,100% { box-shadow: 0 0 15px var(--cyan); } 50% { box-shadow: 0 0 30px var(--cyan), 0 0 60px rgba(0,255,247,0.3); } }
@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
@keyframes fadeUp { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideLeft { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
@keyframes slideRight { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
@keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
@keyframes typingDot { 0%,100% { transform: translateY(0); opacity: 0.3; } 50% { transform: translateY(-5px); opacity: 1; } }
@keyframes imgLoad { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

/* SIDEBAR */
.sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 50; display: none; }
.sidebar-overlay.on { display: block; }
.sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 260px; background: var(--bg2); border-right: 1px solid var(--border); z-index: 60; display: flex; flex-direction: column; transform: translateX(-100%); transition: transform 0.25s ease; }
.sidebar.on { transform: translateX(0); }
.sidebar-header { padding: 16px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.sidebar-title { font-family: 'Orbitron', monospace; font-size: 13px; letter-spacing: 3px; color: var(--cyan); }
.sidebar-close { background: none; border: none; color: rgba(0,255,247,0.4); font-size: 18px; cursor: pointer; padding: 0; }
.sidebar-close:active { color: var(--cyan); }
.new-chat-btn { margin: 12px; padding: 10px; background: transparent; border: 1px solid var(--cyan); color: var(--cyan); font-family: 'Share Tech Mono', monospace; font-size: 11px; letter-spacing: 2px; cursor: pointer; border-radius: 2px; transition: background 0.2s; touch-action: manipulation; }
.new-chat-btn:active { background: rgba(0,255,247,0.1); }
.chat-list { flex: 1; overflow-y: auto; padding: 0 8px 12px; }
.chat-list::-webkit-scrollbar { width: 2px; }
.chat-list::-webkit-scrollbar-thumb { background: rgba(0,255,247,0.2); }
.chat-list-label { font-size: 9px; color: rgba(0,255,247,0.3); letter-spacing: 2px; padding: 10px 6px 6px; }
.chat-item { padding: 10px; border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 8px; border: 1px solid transparent; margin-bottom: 3px; transition: all 0.15s; }
.chat-item:active, .chat-item.active { background: var(--glass); border-color: var(--border); }
.chat-item-title { font-size: 11px; color: rgba(0,255,247,0.7); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
.chat-item.active .chat-item-title { color: var(--cyan); }
.chat-item-del { background: none; border: none; color: rgba(255,0,110,0.3); font-size: 13px; cursor: pointer; padding: 0; flex-shrink: 0; }
.chat-item-del:active { color: var(--pink); }

/* HEADER */
.header { position: relative; z-index: 10; display: flex; align-items: center; gap: 10px; padding: 11px 16px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(0,255,247,0.05), transparent); flex-shrink: 0; }
.menu-btn { background: none; border: none; color: rgba(0,255,247,0.5); font-size: 18px; cursor: pointer; padding: 0; flex-shrink: 0; touch-action: manipulation; }
.menu-btn:active { color: var(--cyan); }
.header-title { font-family: 'Orbitron', monospace; font-size: 18px; font-weight: 900; letter-spacing: 5px; color: var(--cyan); text-shadow: 0 0 20px var(--cyan); flex: 1; text-align: center; }
.newchat-btn { background: none; border: 1px solid rgba(0,255,247,0.25); color: rgba(0,255,247,0.5); font-size: 16px; cursor: pointer; padding: 4px 8px; border-radius: 2px; flex-shrink: 0; touch-action: manipulation; }
.newchat-btn:active { border-color: var(--cyan); color: var(--cyan); }

/* TICKER */
.ticker { position: relative; z-index: 10; display: flex; gap: 18px; padding: 5px 16px; border-bottom: 1px solid var(--border); background: rgba(0,255,247,0.02); overflow-x: auto; flex-shrink: 0; }
.ticker::-webkit-scrollbar { display: none; }
.ticker-item { display: flex; align-items: center; gap: 5px; white-space: nowrap; font-size: 11px; }
.t-name { color: rgba(0,255,247,0.45); }
.t-price { color: var(--cyan); font-weight: bold; }
.t-up { color: var(--green); }
.t-down { color: var(--pink); }

/* CHAT */
.chat { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 16px; display: flex; flex-direction: column; gap: 14px; position: relative; z-index: 10; -webkit-overflow-scrolling: touch; }
.chat::-webkit-scrollbar { width: 3px; }
.chat::-webkit-scrollbar-thumb { background: rgba(0,255,247,0.2); border-radius: 2px; }

.welcome-center { flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; }
.welcome-center h3 { font-family: 'Orbitron', monospace; font-size: 13px; letter-spacing: 2px; color: var(--cyan); margin-bottom: 8px; }
.welcome-center p { font-size: 11px; color: rgba(0,255,247,0.35); letter-spacing: 1px; line-height: 1.8; }

.msg { display: flex; flex-direction: column; gap: 3px; max-width: 86%; }
.msg.ai { align-self: flex-start; animation: slideLeft 0.25s ease; }
.msg.user { align-self: flex-end; align-items: flex-end; animation: slideRight 0.25s ease; }
.msg-label { font-size: 9px; letter-spacing: 2px; padding: 0 3px; }
.msg.ai .msg-label { color: rgba(0,255,247,0.35); }
.msg.user .msg-label { color: rgba(255,0,110,0.4); }
.msg-bubble { padding: 4px 3px; font-size: 13px; line-height: 1.75; white-space: pre-wrap; word-break: break-word; background: transparent; border: none; }
.msg.ai .msg-bubble { color: rgba(0,255,247,0.88); }
.msg.user .msg-bubble { color: rgba(255,200,215,0.88); }

/* Image message */
.msg-image { max-width: 100%; border-radius: 4px; border: 1px solid var(--border); animation: imgLoad 0.4s ease; margin-top: 4px; display: block; }
.img-actions { display: flex; gap: 8px; margin-top: 6px; }
.img-action-btn { background: transparent; border: 1px solid rgba(0,255,247,0.25); color: rgba(0,255,247,0.6); font-family: 'Share Tech Mono', monospace; font-size: 10px; padding: 4px 10px; border-radius: 2px; cursor: pointer; touch-action: manipulation; }
.img-action-btn:active { background: rgba(0,255,247,0.1); color: var(--cyan); }

.typing-wrap { display: flex; flex-direction: column; gap: 3px; align-self: flex-start; }
.typing-label { font-size: 9px; letter-spacing: 2px; color: rgba(0,255,247,0.35); padding: 0 3px; }
.typing-dots { display: flex; align-items: center; gap: 7px; padding: 8px 4px; }
.typing-dots span { width: 6px; height: 6px; background: var(--cyan); border-radius: 50%; animation: typingDot 1.1s ease-in-out infinite; box-shadow: 0 0 5px var(--cyan); }
.typing-dots span:nth-child(2) { animation-delay: 0.18s; }
.typing-dots span:nth-child(3) { animation-delay: 0.36s; }
.typing-hint { font-size: 9px; color: rgba(0,255,247,0.3); margin-left: 8px; }

/* INPUT */
.input-area { position: relative; z-index: 10; padding: 10px 14px 14px; border-top: 1px solid var(--border); background: linear-gradient(0deg, rgba(0,255,247,0.03), transparent); flex-shrink: 0; }
.input-row { display: flex; align-items: flex-end; gap: 8px; background: var(--glass); border: 1px solid var(--border); border-radius: 3px; padding: 9px 11px; transition: border-color 0.25s; }
.input-row:focus-within { border-color: rgba(0,255,247,0.45); }
#msgInput { flex: 1; background: transparent; border: none; outline: none; color: var(--cyan); font-family: 'Share Tech Mono', monospace; font-size: 13px; line-height: 1.5; resize: none; min-height: 22px; max-height: 96px; overflow-y: auto; }
#msgInput::placeholder { color: rgba(0,255,247,0.22); }
.btn-send { width: 36px; height: 36px; background: rgba(0,255,247,0.06); border: 1px solid var(--cyan); color: var(--cyan); border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; flex-shrink: 0; transition: all 0.2s; touch-action: manipulation; }
.btn-send:active { background: rgba(0,255,247,0.15); }
.btn-send:disabled { opacity: 0.3; pointer-events: none; }
.input-hint { font-size: 9px; color: rgba(0,255,247,0.18); letter-spacing: 0.8px; margin-top: 5px; }

/* SETUP */
.setup { position: fixed; inset: 0; background: rgba(5,10,14,0.97); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; }
.setup-box { width: 100%; max-width: 340px; border: 1px solid var(--cyan); background: var(--bg2); padding: 28px 22px; box-shadow: 0 0 40px rgba(0,255,247,0.08); animation: fadeUp 0.4s ease; }
.setup-tag { font-size: 9px; color: var(--pink); letter-spacing: 3px; margin-bottom: 14px; animation: blink 2s step-end infinite; }
.setup-box h2 { font-family: 'Orbitron', monospace; font-size: 17px; font-weight: 700; letter-spacing: 3px; color: var(--cyan); text-shadow: 0 0 18px var(--cyan); margin-bottom: 5px; }
.setup-box p { font-size: 11px; color: rgba(0,255,247,0.45); line-height: 1.7; margin-bottom: 3px; }
.setup-div { height: 1px; background: linear-gradient(90deg, transparent, var(--cyan), transparent); margin: 18px 0; }
.setup-box input { width: 100%; background: rgba(0,255,247,0.04); border: none; border-bottom: 2px solid var(--cyan); color: var(--cyan); font-family: 'Share Tech Mono', monospace; font-size: 12px; padding: 10px; outline: none; margin-bottom: 16px; letter-spacing: 1px; }
.setup-box input::placeholder { color: rgba(0,255,247,0.2); }
.setup-go { width: 100%; background: transparent; border: 1px solid var(--cyan); color: var(--cyan); font-family: 'Orbitron', monospace; font-size: 12px; font-weight: 700; letter-spacing: 3px; padding: 12px; cursor: pointer; transition: background 0.2s; touch-action: manipulation; }
.setup-go:active { background: rgba(0,255,247,0.1); }
</style>
</head>
<body>
<div class="grid-bg"></div>
<div class="scanlines"></div>

<!-- SETUP -->
<div class="setup" id="setup">
  <div class="setup-box">
    <div class="setup-tag">‚óÜ SYSTEM INIT ‚óÜ</div>
    <h2>OBAN.AI</h2>
    <p>Masukkan Groq API Key untuk mengaktifkan sistem.</p>
    <p style="color:rgba(0,255,247,0.28);font-size:10px;margin-top:3px;">Daftar gratis di console.groq.com</p>
    <div class="setup-div"></div>
    <input type="password" id="keyInput" placeholder="gsk_xxxxxxxxxxxxxxxx" />
    <button class="setup-go" id="setupBtn">‚ñ∂ INISIALISASI SISTEM</button>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">RIWAYAT</div>
    <button class="sidebar-close" id="sidebarClose">‚úï</button>
  </div>
  <button class="new-chat-btn" id="newChatSidebar">+ CHAT BARU</button>
  <div class="chat-list" id="chatList"></div>
</div>

<!-- HEADER -->
<div class="header">
  <button class="menu-btn" id="menuBtn">‚ò∞</button>
  <div class="header-title">OBAN</div>
  <button class="newchat-btn" id="newChatBtn">‚úè</button>
</div>

<!-- TICKER -->
<div class="ticker" id="ticker">
  <div style="color:rgba(0,255,247,0.25);font-size:10px;">‚ü≥ LOADING...</div>
</div>

<!-- CHAT -->
<div class="chat" id="chat">
  <div class="welcome-center" id="welcomeMsg">
    <div>
      <div style="font-family:'Orbitron',monospace;font-size:14px;color:var(--cyan);letter-spacing:2px;margin-bottom:10px;">HELO, SAYA OBAN</div>
      <div style="font-size:11px;color:rgba(0,255,247,0.35);letter-spacing:1px;line-height:1.9;">Tanyakan apa saja kepada saya<br><span style="color:rgba(0,255,247,0.2);">üí° Ketik "buatkan gambar ..." untuk generate gambar</span></div>
    </div>
  </div>
</div>

<!-- INPUT -->
<div class="input-area">
  <div class="input-row">
    <textarea id="msgInput" placeholder="Ketik pesan atau 'buatkan gambar ...'" rows="1"></textarea>
    <button class="btn-send" id="sendBtn">‚ñ∂</button>
  </div>
  <div class="input-hint">ENTER = KIRIM &nbsp;|&nbsp; SHIFT+ENTER = BARIS BARU</div>
</div>

<script>
(function() {
  let apiKey = localStorage.getItem('oban_key') || '';
  let busy = false;
  let currentId = null;
  let sessions = JSON.parse(localStorage.getItem('oban_sessions') || '{}');
  let history = [];

  const setupEl    = document.getElementById('setup');
  const setupBtn   = document.getElementById('setupBtn');
  const keyInput   = document.getElementById('keyInput');
  const chatEl     = document.getElementById('chat');
  const msgInput   = document.getElementById('msgInput');
  const sendBtn    = document.getElementById('sendBtn');
  const ticker     = document.getElementById('ticker');
  const sidebar    = document.getElementById('sidebar');
  const sidebarOvl = document.getElementById('sidebarOverlay');
  const sidebarClose = document.getElementById('sidebarClose');
  const menuBtn    = document.getElementById('menuBtn');
  const newChatBtn = document.getElementById('newChatBtn');
  const newChatSB  = document.getElementById('newChatSidebar');
  const chatList   = document.getElementById('chatList');

  if (apiKey) setupEl.style.display = 'none';

  // ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ
  setupBtn.addEventListener('click', function() {
    const k = keyInput.value.trim();
    if (!k) return;
    apiKey = k;
    localStorage.setItem('oban_key', k);
    setupEl.style.display = 'none';
    msgInput.focus();
  });
  keyInput.addEventListener('keydown', e => { if (e.key === 'Enter') setupBtn.click(); });

  // ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ
  menuBtn.addEventListener('click', openSidebar);
  sidebarClose.addEventListener('click', closeSidebar);
  sidebarOvl.addEventListener('click', closeSidebar);

  function openSidebar() { sidebar.classList.add('on'); sidebarOvl.classList.add('on'); renderChatList(); }
  function closeSidebar() { sidebar.classList.remove('on'); sidebarOvl.classList.remove('on'); }

  // ‚îÄ‚îÄ SESSIONS ‚îÄ‚îÄ
  function saveSessions() { localStorage.setItem('oban_sessions', JSON.stringify(sessions)); }

  function newChat() {
    currentId = Date.now().toString();
    history = [];
    sessions[currentId] = { title: 'Chat Baru', messages: [] };
    saveSessions();
    chatEl.innerHTML = `<div class="welcome-center" id="welcomeMsg">
      <div>
        <div style="font-family:'Orbitron',monospace;font-size:14px;color:var(--cyan);letter-spacing:2px;margin-bottom:10px;">HELO, SAYA OBAN</div>
        <div style="font-size:11px;color:rgba(0,255,247,0.35);letter-spacing:1px;line-height:1.9;">Tanyakan apa saja kepada saya<br><span style="color:rgba(0,255,247,0.2);">üí° Ketik "buatkan gambar ..." untuk generate gambar</span></div>
      </div>
    </div>`;
    closeSidebar();
    msgInput.focus();
  }

  function loadChat(id) {
    currentId = id;
    const s = sessions[id];
    if (!s) return;
    history = s.messages.filter(m => m.role !== 'image').map(m => ({ role: m.role, content: m.content }));
    chatEl.innerHTML = '';
    s.messages.forEach(m => {
      if (m.role === 'image') addImageMsg(m.url, m.prompt, false);
      else addMsg(m.role === 'user' ? 'user' : 'ai', m.content, false);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
    closeSidebar();
  }

  function deleteChat(id) {
    delete sessions[id];
    saveSessions();
    if (currentId === id) newChat();
    else renderChatList();
  }

  function renderChatList() {
    chatList.innerHTML = '';
    const ids = Object.keys(sessions).sort((a,b) => b - a);
    if (!ids.length) {
      chatList.innerHTML = '<div style="font-size:10px;color:rgba(0,255,247,0.25);padding:12px 6px;letter-spacing:1px;">BELUM ADA RIWAYAT</div>';
      return;
    }
    chatList.innerHTML = '<div class="chat-list-label">PERCAKAPAN</div>';
    ids.forEach(id => {
      const s = sessions[id];
      const item = document.createElement('div');
      item.className = 'chat-item' + (id === currentId ? ' active' : '');
      item.innerHTML = `<span class="chat-item-title">${s.title}</span><button class="chat-item-del" data-id="${id}">‚úï</button>`;
      item.addEventListener('click', function(e) {
        if (e.target.classList.contains('chat-item-del')) { deleteChat(e.target.dataset.id); return; }
        loadChat(id);
      });
      chatList.appendChild(item);
    });
  }

  newChatBtn.addEventListener('click', newChat);
  newChatSB.addEventListener('click', newChat);

  // ‚îÄ‚îÄ TEXTAREA ‚îÄ‚îÄ
  msgInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 96) + 'px';
  });
  msgInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); doSend(); }
  });
  sendBtn.addEventListener('click', doSend);

  // ‚îÄ‚îÄ CRYPTO ‚îÄ‚îÄ
  async function fetchTicker() {
    try {
      const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,binancecoin,ripple,hyperliquid&vs_currencies=usd&include_24hr_change=true');
      const d = await r.json();
      renderTicker(d);
    } catch(e) {}
  }

  function renderTicker(d) {
    const map = {bitcoin:'BTC',ethereum:'ETH',solana:'SOL',binancecoin:'BNB',ripple:'XRP',hyperliquid:'HYPE'};
    ticker.innerHTML = '';
    for (const [id, sym] of Object.entries(map)) {
      if (!d[id]) continue;
      const p = d[id].usd, c = d[id].usd_24h_change;
      const ps = p >= 1 ? '$'+p.toLocaleString('en-US',{maximumFractionDigits:2}) : '$'+p.toFixed(5);
      const cls = c >= 0 ? 't-up' : 't-down';
      const sign = c >= 0 ? '+' : '';
      ticker.innerHTML += `<div class="ticker-item"><span class="t-name">${sym}</span><span class="t-price">${ps}</span><span class="${cls}">${sign}${c.toFixed(2)}%</span></div>`;
    }
  }

  async function searchCoin(q) {
    try {
      const r = await fetch('https://api.coingecko.com/api/v3/search?query='+encodeURIComponent(q));
      const d = await r.json();
      return d.coins && d.coins[0] ? d.coins[0].id : null;
    } catch(e) { return null; }
  }

  async function fetchPrices(ids) {
    try {
      const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids='+ids.join(',')+'&vs_currencies=usd&include_24hr_change=true&include_market_cap=true');
      return await r.json();
    } catch(e) { return {}; }
  }

  const STOP = new Set(['berapa','harga','sekarang','token','coin','crypto','nilai','info','tentang','dan','yang','di','ke','dari','untuk','adalah','ada','tolong','kasih','tahu','beri','hari','ini','saat','market','pasar','cek','lihat','tampilkan','top']);

  async function getCryptoContext(text) {
    const words = text.toLowerCase().replace(/[?!.,]/g,'').split(/\s+/).filter(w => w.length >= 2 && !STOP.has(w));
    if (!words.length) return '';
    const direct = await fetchPrices(words.slice(0,3));
    const valid = {};
    for (const [id, v] of Object.entries(direct)) { if (v && v.usd) valid[id] = v; }
    if (!Object.keys(valid).length) {
      for (const w of words.slice(0,2)) {
        const id = await searchCoin(w);
        if (id) { const d = await fetchPrices([id]); if (d[id] && d[id].usd) { valid[id] = d[id]; break; } }
      }
    }
    if (!Object.keys(valid).length) return '';
    let ctx = '\n\n[DATA CRYPTO REALTIME ‚Äî '+new Date().toLocaleString('id-ID')+']\n';
    for (const [id, v] of Object.entries(valid)) {
      const p = v.usd, c = v.usd_24h_change, mc = v.usd_market_cap;
      const ps = p >= 1 ? '$'+p.toLocaleString('en-US',{maximumFractionDigits:2}) : '$'+p.toFixed(6);
      const mcs = mc ? ' | MCap $'+(mc/1e9).toFixed(2)+'B' : '';
      ctx += id+': '+ps+' (24j: '+(c>=0?'+':'')+c.toFixed(2)+'%)'+mcs+'\n';
    }
    return ctx;
  }

  function isCryptoQ(text) {
    const kw = ['harga','price','berapa','crypto','token','coin','bitcoin','ethereum','btc','eth','market','pasar','naik','turun'];
    return kw.some(k => text.toLowerCase().includes(k));
  }

  // ‚îÄ‚îÄ IMAGE GENERATION ‚îÄ‚îÄ
  function isImageRequest(text) {
    const kw = ['buatkan gambar','buat gambar','generate gambar','gambarkan','buatkan foto','buat foto','create image','generate image','buatin gambar'];
    return kw.some(k => text.toLowerCase().includes(k));
  }

  function extractImagePrompt(text) {
    const patterns = [
      /buatkan gambar(?: dari| tentang| dengan)?\s+(.+)/i,
      /buat gambar(?: dari| tentang| dengan)?\s+(.+)/i,
      /generate gambar(?: dari| tentang| dengan)?\s+(.+)/i,
      /gambarkan\s+(.+)/i,
      /buatkan foto(?: dari| tentang| dengan)?\s+(.+)/i,
      /buat foto(?: dari| tentang| dengan)?\s+(.+)/i,
      /buatin gambar(?: dari| tentang| dengan)?\s+(.+)/i,
      /create image of\s+(.+)/i,
      /generate image of\s+(.+)/i,
    ];
    for (const p of patterns) {
      const m = text.match(p);
      if (m && m[1]) return m[1].trim();
    }
    return text;
  }

  function addImageMsg(url, prompt, save = true) {
    const wm = document.getElementById('welcomeMsg');
    if (wm) wm.remove();

    const wrap = document.createElement('div');
    wrap.className = 'msg ai';
    const lbl = document.createElement('div');
    lbl.className = 'msg-label';
    lbl.textContent = '‚óÜ OBAN';

    const img = document.createElement('img');
    img.className = 'msg-image';
    img.alt = prompt;
    img.style.maxWidth = '260px';

    // Loading placeholder
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = 'font-size:11px;color:rgba(0,255,247,0.4);padding:4px 3px;';
    loadingDiv.textContent = '‚ü≥ Generating image...';
    wrap.appendChild(lbl);
    wrap.appendChild(loadingDiv);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;

    img.onload = function() {
      loadingDiv.remove();
      wrap.appendChild(img);

      // Download button
      const actions = document.createElement('div');
      actions.className = 'img-actions';
      const dlBtn = document.createElement('a');
      dlBtn.href = url;
      dlBtn.download = 'oban-image.jpg';
      dlBtn.target = '_blank';
      dlBtn.className = 'img-action-btn';
      dlBtn.textContent = '‚¨á Download';
      actions.appendChild(dlBtn);
      wrap.appendChild(actions);
      chatEl.scrollTop = chatEl.scrollHeight;
    };

    img.onerror = function() {
      loadingDiv.textContent = '‚ö† Gagal generate gambar, coba lagi.';
    };

    img.src = url;

    if (save && currentId && sessions[currentId]) {
      sessions[currentId].messages.push({ role: 'image', url, prompt });
      saveSessions();
    }
  }

  // ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ
  function addMsg(role, text, save = true) {
    const wm = document.getElementById('welcomeMsg');
    if (wm) wm.remove();

    const wrap = document.createElement('div');
    wrap.className = 'msg ' + role;
    const lbl = document.createElement('div');
    lbl.className = 'msg-label';
    lbl.textContent = role === 'ai' ? '‚óÜ OBAN' : 'USER ‚óÜ';
    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    bubble.textContent = text;
    wrap.appendChild(lbl);
    wrap.appendChild(bubble);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;

    if (save && currentId && sessions[currentId]) {
      sessions[currentId].messages.push({ role: role === 'ai' ? 'assistant' : 'user', content: text });
      if (role === 'user' && sessions[currentId].messages.filter(m => m.role === 'user').length === 1) {
        sessions[currentId].title = text.slice(0,30) + (text.length > 30 ? '...' : '');
      }
      saveSessions();
    }
  }

  function showTyping(hint) {
    removeTyping();
    const wrap = document.createElement('div');
    wrap.className = 'typing-wrap'; wrap.id = 'typing';
    const lbl = document.createElement('div');
    lbl.className = 'typing-label'; lbl.textContent = '‚óÜ OBAN';
    const dots = document.createElement('div');
    dots.className = 'typing-dots';
    dots.innerHTML = '<span></span><span></span><span></span>';
    if (hint) { const h = document.createElement('span'); h.className = 'typing-hint'; h.textContent = hint; dots.appendChild(h); }
    wrap.appendChild(lbl); wrap.appendChild(dots);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function removeTyping() { const el = document.getElementById('typing'); if (el) el.remove(); }

  // ‚îÄ‚îÄ MAIN SEND ‚îÄ‚îÄ
  async function doSend() {
    if (busy) return;
    const text = msgInput.value.trim();
    if (!text) return;
    if (!currentId) newChat();

    msgInput.value = '';
    msgInput.style.height = 'auto';
    busy = true;
    sendBtn.disabled = true;

    addMsg('user', text);

    // ‚îÄ‚îÄ IMAGE GENERATION ‚îÄ‚îÄ
    if (isImageRequest(text)) {
      const prompt = extractImagePrompt(text);
      showTyping('GENERATING IMAGE...');
      const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt + ', high quality, detailed, cyberpunk style')}?width=512&height=512&nologo=true`;
      removeTyping();
      addImageMsg(imageUrl, prompt);
      busy = false;
      sendBtn.disabled = false;
      msgInput.focus();
      return;
    }

    // ‚îÄ‚îÄ CRYPTO ‚îÄ‚îÄ
    let ctx = '';
    if (isCryptoQ(text)) {
      showTyping('FETCHING CRYPTO DATA...');
      ctx = await getCryptoContext(text);
      removeTyping();
    }

    history.push({ role: 'user', content: text + ctx });
    showTyping();

    try {
      const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'llama-3.3-70b-versatile',
          max_tokens: 1024,
          messages: [
            { role: 'system', content: `Kamu adalah OBAN, asisten AI pribadi yang sangat cerdas, analitis, dan berpengetahuan luas. Dibuat khusus untuk pemilikmu.

KEPRIBADIAN:
- Cerdas, to the point, tapi tetap ramah dan natural
- Tidak bertele-tele, langsung ke inti jawaban
- Jika ditanya opini, berani memberikan pendapat yang jelas
- Selalu jawab dalam Bahasa Indonesia yang natural

KEAHLIAN UTAMA:
- Crypto & trading: analisis harga, tren market, tokenomics
- Teknologi & AI: selalu update dengan perkembangan terbaru
- Keuangan: investasi, manajemen aset, analisis risiko
- Pengetahuan umum: sains, sejarah, budaya, dan lainnya

ATURAN:
- Jika ada data crypto realtime dalam pesan, gunakan untuk menjawab dengan akurat dan tambahkan analisis singkat
- Jika ditanya prediksi harga, berikan analisis berdasarkan data yang ada dengan disclaimer
- Jika tidak tahu sesuatu, katakan dengan jujur
- Jawab singkat untuk pertanyaan singkat, jawab detail untuk pertanyaan kompleks
- Kamu juga bisa generate gambar, tapi itu sudah dihandle otomatis oleh sistem
- Tanggal dan waktu sekarang: ${new Date().toLocaleString('id-ID', {weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'})}` },
            ...history
          ]
        })
      });

      const data = await res.json();
      removeTyping();

      if (data.choices && data.choices[0]) {
        const reply = data.choices[0].message.content;
        history.push({ role: 'assistant', content: reply });
        addMsg('ai', reply);
      } else {
        addMsg('ai', '‚ö† ' + (data.error?.message || 'Gagal mendapat respons'));
      }
    } catch(e) {
      removeTyping();
      addMsg('ai', '‚ö† CONNECTION ERROR: Periksa koneksi internet Anda.');
    }

    busy = false;
    sendBtn.disabled = false;
    msgInput.focus();
  }

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
  fetchTicker();
  setInterval(fetchTicker, 60000);

})();
</script>
</body>
</html>
