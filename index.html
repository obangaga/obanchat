<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OBAN AI</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --cyan: #00fff7;
    --pink: #ff006e;
    --yellow: #ffe600;
    --green: #00ff88;
    --bg: #050a0e;
    --bg2: #0a1628;
    --glass: rgba(0,255,247,0.04);
    --border: rgba(0,255,247,0.15);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--cyan); font-family: 'Share Tech Mono', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: relative; }
  body::before { content: ''; position: fixed; inset: 0; background-image: linear-gradient(rgba(0,255,247,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,255,247,0.03) 1px, transparent 1px); background-size: 40px 40px; animation: gridMove 20s linear infinite; pointer-events: none; z-index: 0; }
  body::after { content: ''; position: fixed; inset: 0; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.15) 2px, rgba(0,0,0,0.15) 4px); pointer-events: none; z-index: 999; }
  @keyframes gridMove { 0% { transform: translateY(0); } 100% { transform: translateY(40px); } }

  .header { position: relative; z-index: 10; padding: 12px 20px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(0,255,247,0.05) 0%, transparent 100%); display: flex; align-items: center; gap: 12px; }
  .header-logo { width: 36px; height: 36px; border: 2px solid var(--cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron', monospace; font-weight: 900; font-size: 14px; color: var(--cyan); box-shadow: 0 0 15px var(--cyan), inset 0 0 10px rgba(0,255,247,0.1); animation: pulse 2s ease-in-out infinite; flex-shrink: 0; }
  @keyframes pulse { 0%, 100% { box-shadow: 0 0 15px var(--cyan), inset 0 0 10px rgba(0,255,247,0.1); } 50% { box-shadow: 0 0 30px var(--cyan), 0 0 60px rgba(0,255,247,0.3), inset 0 0 20px rgba(0,255,247,0.2); } }
  .header-info h1 { font-family: 'Orbitron', monospace; font-size: 18px; font-weight: 900; letter-spacing: 4px; color: var(--cyan); text-shadow: 0 0 20px var(--cyan); }
  .header-info .status { font-size: 10px; color: var(--pink); letter-spacing: 2px; animation: blink 1.5s step-end infinite; }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
  .header-decor { margin-left: auto; font-size: 10px; color: rgba(0,255,247,0.4); text-align: right; line-height: 1.6; }

  .crypto-ticker { position: relative; z-index: 10; background: rgba(0,255,247,0.03); border-bottom: 1px solid var(--border); padding: 6px 16px; display: flex; gap: 20px; overflow-x: auto; font-size: 11px; letter-spacing: 1px; }
  .crypto-ticker::-webkit-scrollbar { display: none; }
  .ticker-item { display: flex; align-items: center; gap: 6px; white-space: nowrap; cursor: pointer; }
  .ticker-name { color: rgba(0,255,247,0.5); }
  .ticker-price { color: var(--cyan); font-weight: bold; }
  .ticker-change.up { color: var(--green); }
  .ticker-change.down { color: var(--pink); }

  .chat-area { flex: 1; overflow-y: auto; padding: 20px 16px; position: relative; z-index: 10; display: flex; flex-direction: column; gap: 16px; }
  .chat-area::-webkit-scrollbar { width: 4px; }
  .chat-area::-webkit-scrollbar-thumb { background: var(--cyan); border-radius: 2px; }

  .welcome { text-align: center; padding: 20px; animation: fadeIn 1s ease; }
  .welcome-title { font-family: 'Orbitron', monospace; font-size: 28px; font-weight: 900; color: var(--cyan); text-shadow: 0 0 30px var(--cyan), 0 0 60px rgba(0,255,247,0.5); letter-spacing: 6px; margin-bottom: 8px; }
  .welcome-sub { font-size: 11px; color: var(--pink); letter-spacing: 3px; margin-bottom: 16px; }
  .welcome-line { width: 100%; height: 1px; background: linear-gradient(90deg, transparent, var(--cyan), transparent); margin: 12px 0; }
  .quick-btns { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 12px; }
  .quick-btn { background: var(--glass); border: 1px solid var(--border); color: rgba(0,255,247,0.7); font-family: 'Share Tech Mono', monospace; font-size: 10px; letter-spacing: 1px; padding: 6px 12px; cursor: pointer; transition: all 0.2s; border-radius: 2px; }
  .quick-btn:hover, .quick-btn:active { background: rgba(0,255,247,0.1); border-color: var(--cyan); color: var(--cyan); }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  .message { display: flex; flex-direction: column; gap: 4px; animation: slideIn 0.3s ease; max-width: 88%; }
  @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
  .message.user { align-self: flex-end; align-items: flex-end; animation: slideInRight 0.3s ease; }
  @keyframes slideInRight { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
  .message-label { font-size: 9px; letter-spacing: 2px; color: rgba(0,255,247,0.5); padding: 0 4px; display: flex; align-items: center; gap: 6px; }
  .message.user .message-label { color: rgba(255,0,110,0.6); }
  .message-bubble { padding: 12px 16px; border-radius: 2px; font-size: 13px; line-height: 1.7; position: relative; white-space: pre-wrap; word-break: break-word; }
  .message.ai .message-bubble { background: var(--glass); border: 1px solid var(--border); border-left: 3px solid var(--cyan); color: rgba(0,255,247,0.9); }
  .message.user .message-bubble { background: rgba(255,0,110,0.08); border: 1px solid rgba(255,0,110,0.2); border-right: 3px solid var(--pink); color: rgba(255,200,220,0.9); }
  .message.ai .message-bubble::before { content: '‚ñ∂'; position: absolute; top: -1px; left: -12px; font-size: 8px; color: var(--cyan); }

  /* Speak button on AI messages */
  .speak-btn { background: transparent; border: none; color: rgba(0,255,247,0.4); cursor: pointer; font-size: 12px; padding: 0; transition: color 0.2s; }
  .speak-btn:hover { color: var(--cyan); }
  .speak-btn.speaking { color: var(--green); animation: blink 0.8s step-end infinite; }

  .typing { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: var(--glass); border: 1px solid var(--border); border-left: 3px solid var(--cyan); width: fit-content; }
  .typing span { width: 6px; height: 6px; background: var(--cyan); border-radius: 50%; animation: typingDot 1.2s ease-in-out infinite; box-shadow: 0 0 6px var(--cyan); }
  .typing span:nth-child(2) { animation-delay: 0.2s; }
  .typing span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typingDot { 0%, 100% { transform: translateY(0); opacity: 0.4; } 50% { transform: translateY(-6px); opacity: 1; } }

  .input-area { position: relative; z-index: 10; padding: 12px 16px 16px; border-top: 1px solid var(--border); background: linear-gradient(0deg, rgba(0,255,247,0.03) 0%, transparent 100%); }
  .input-wrapper { display: flex; align-items: flex-end; gap: 8px; background: var(--glass); border: 1px solid var(--border); border-radius: 2px; padding: 10px 12px; transition: border-color 0.3s; position: relative;
    z-index: 20; }
  .input-wrapper:focus-within { border-color: var(--cyan); box-shadow: 0 0 20px rgba(0,255,247,0.1); }
  .input-wrapper textarea { flex: 1; background: transparent; border: none; outline: none; color: var(--cyan); font-family: 'Share Tech Mono', monospace; font-size: 13px; line-height: 1.5; resize: none; min-height: 20px; max-height: 100px; overflow-y: auto; }
  .input-wrapper textarea::placeholder { color: rgba(0,255,247,0.25); }

  .mic-btn { background: transparent; border: 1px solid rgba(0,255,247,0.3); color: rgba(0,255,247,0.5); width: 34px; height: 34px; border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; flex-shrink: 0; position: relative;
    z-index: 20; }
  .mic-btn:hover { border-color: var(--cyan); color: var(--cyan); }
  .mic-btn.recording { border-color: var(--pink); color: var(--pink); box-shadow: 0 0 15px rgba(255,0,110,0.4); animation: micPulse 0.8s ease-in-out infinite; }
  @keyframes micPulse { 0%, 100% { box-shadow: 0 0 10px rgba(255,0,110,0.3); } 50% { box-shadow: 0 0 25px rgba(255,0,110,0.7); } }

  .send-btn { background: transparent; border: 1px solid var(--cyan); color: var(--cyan); width: 34px; height: 34px; border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: all 0.2s; flex-shrink: 0; position: relative;
    z-index: 20; }
  .send-btn:hover { background: rgba(0,255,247,0.1); }
  .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .input-hint { font-size: 9px; color: rgba(0,255,247,0.2); letter-spacing: 1px; margin-top: 6px; }

  /* Voice wave animation */
  .voice-wave { display: none; align-items: center; gap: 3px; height: 20px; }
  .voice-wave.active { display: flex; }
  .voice-wave span { width: 3px; background: var(--pink); border-radius: 2px; animation: wave 0.6s ease-in-out infinite; }
  .voice-wave span:nth-child(1) { height: 8px; animation-delay: 0s; }
  .voice-wave span:nth-child(2) { height: 16px; animation-delay: 0.1s; }
  .voice-wave span:nth-child(3) { height: 12px; animation-delay: 0.2s; }
  .voice-wave span:nth-child(4) { height: 18px; animation-delay: 0.15s; }
  .voice-wave span:nth-child(5) { height: 8px; animation-delay: 0.05s; }
  @keyframes wave { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1.2); } }

  .setup-overlay { position: fixed; inset: 0; background: rgba(5,10,14,0.95); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
  .setup-box { width: 100%; max-width: 340px; border: 1px solid var(--cyan); background: var(--bg2); padding: 28px 24px; box-shadow: 0 0 40px rgba(0,255,247,0.1); animation: fadeIn 0.5s ease; }
  .setup-box::before { content: '‚óÜ SYSTEM INIT ‚óÜ'; display: block; font-size: 9px; color: var(--pink); letter-spacing: 3px; margin-bottom: 14px; animation: blink 2s step-end infinite; }
  .setup-box h2 { font-family: 'Orbitron', monospace; font-size: 16px; font-weight: 700; color: var(--cyan); letter-spacing: 3px; text-shadow: 0 0 20px var(--cyan); margin-bottom: 6px; }
  .setup-box p { font-size: 11px; color: rgba(0,255,247,0.5); letter-spacing: 1px; margin-bottom: 20px; line-height: 1.6; }
  .setup-divider { height: 1px; background: linear-gradient(90deg, transparent, var(--cyan), transparent); margin: 20px 0; }
  .setup-box input { width: 100%; background: rgba(0,255,247,0.05); border: 1px solid var(--border); border-bottom: 2px solid var(--cyan); color: var(--cyan); font-family: 'Share Tech Mono', monospace; font-size: 12px; padding: 10px 12px; outline: none; margin-bottom: 16px; }
  .setup-box input::placeholder { color: rgba(0,255,247,0.2); }
  .setup-btn { width: 100%; background: transparent; border: 1px solid var(--cyan); color: var(--cyan); font-family: 'Orbitron', monospace; font-size: 12px; font-weight: 700; letter-spacing: 3px; padding: 12px; cursor: pointer; transition: all 0.3s; }
  .setup-btn:hover { background: rgba(0,255,247,0.1); }
</style>
</head>
<body>

<div class="setup-overlay" id="setupOverlay">
  <div class="setup-box">
    <h2>OBAN.AI</h2>
    <p>Masukkan Groq API Key untuk mengaktifkan sistem.</p>
    <div class="setup-divider"></div>
    <input type="password" id="apiKeyInput" placeholder="gsk_xxxxxxxxxxxxxxxxxxxx" />
    <button class="setup-btn" onclick="saveApiKey()">‚ñ∂ INISIALISASI SISTEM</button>
  </div>
</div>

<div class="header">
  <div class="header-logo">O</div>
  <div class="header-info">
    <h1>OBAN</h1>
    <div class="status" id="statusText">‚óè ONLINE // READY</div>
  </div>
  <div class="header-decor">
    <div>SYS v5.0.0</div>
    <div style="color:rgba(255,230,0,0.5)">VOICE + CRYPTO</div>
  </div>
</div>

<div class="crypto-ticker" id="cryptoTicker">
  <div class="ticker-item" style="color:rgba(0,255,247,0.3)">‚ü≥ LOADING MARKET DATA...</div>
</div>

<div class="chat-area" id="chatArea">
  <div class="welcome">
    <div class="welcome-title">OBAN</div>
    <div class="welcome-sub">VOICE AI // 10.000+ CRYPTO TOKENS</div>
    <div class="welcome-line"></div>
    <div style="font-size:11px; color:rgba(0,255,247,0.4); letter-spacing:1px; line-height:1.8">
      üé§ KETUK MIC UNTUK BICARA<br>
      üîä OBAN AKAN MEMBALAS DENGAN SUARA<br>
      üîç BISA CARI HARGA TOKEN APAPUN
    </div>
    <div class="quick-btns">
      <button class="quick-btn" onclick="quickAsk('Berapa harga bitcoin sekarang?')">‚Çø BTC</button>
      <button class="quick-btn" onclick="quickAsk('Berapa harga ethereum sekarang?')">‚¨° ETH</button>
      <button class="quick-btn" onclick="quickAsk('Berapa harga hyperliquid sekarang?')">‚ö° HYPE</button>
      <button class="quick-btn" onclick="quickAsk('Berapa harga solana sekarang?')">‚óé SOL</button>
      <button class="quick-btn" onclick="quickAsk('Tampilkan top 5 crypto hari ini')">üìä TOP 5</button>
    </div>
  </div>
</div>

<div class="input-area">
  <div class="input-wrapper">
    <div class="voice-wave" id="voiceWave">
      <span></span><span></span><span></span><span></span><span></span>
    </div>
    <textarea id="messageInput" placeholder="Ketik atau tekan üé§ untuk bicara..." rows="1"
      onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <button class="mic-btn" id="micBtn" onclick="toggleMic()" title="Tekan untuk bicara">üé§</button>
    <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚ñ∂</button>
  </div>
  <div class="input-hint">ENTER = KIRIM &nbsp;|&nbsp; üé§ = SUARA &nbsp;|&nbsp; üîä = AUTO SPEAK</div>
</div>

<script>
  let apiKey = localStorage.getItem('oban_api_key') || '';
  let isLoading = false;
  let conversationHistory = [];
  let cryptoData = {};
  let isRecording = false;
  let recognition = null;
  let isSpeaking = false;
  let autoSpeak = true;

  if (apiKey) document.getElementById('setupOverlay').style.display = 'none';

  function saveApiKey() {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (!key) return;
    apiKey = key;
    localStorage.setItem('oban_api_key', key);
    document.getElementById('setupOverlay').style.display = 'none';
    initSpeech();
    document.getElementById('messageInput').focus();
  }

  // ==================== SPEECH TO TEXT ====================
  function initSpeech() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      document.getElementById('micBtn').style.opacity = '0.3';
      document.getElementById('micBtn').title = 'Browser tidak support speech recognition';
      return;
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'id-ID';
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = (e) => {
      const transcript = e.results[0][0].transcript;
      document.getElementById('messageInput').value = transcript;
      autoResize(document.getElementById('messageInput'));
      stopMic();
      sendMessage();
    };

    recognition.onerror = () => stopMic();
    recognition.onend = () => stopMic();
  }

  function toggleMic() {
    if (isRecording) { stopMic(); return; }
    if (!recognition) { initSpeech(); if (!recognition) return; }
    isRecording = true;
    document.getElementById('micBtn').classList.add('recording');
    document.getElementById('micBtn').textContent = '‚èπ';
    document.getElementById('voiceWave').classList.add('active');
    document.getElementById('messageInput').placeholder = 'Mendengarkan...';
    document.getElementById('statusText').textContent = '‚óè LISTENING...';
    recognition.start();
  }

  function stopMic() {
    isRecording = false;
    document.getElementById('micBtn').classList.remove('recording');
    document.getElementById('micBtn').textContent = 'üé§';
    document.getElementById('voiceWave').classList.remove('active');
    document.getElementById('messageInput').placeholder = 'Ketik atau tekan üé§ untuk bicara...';
    document.getElementById('statusText').textContent = '‚óè ONLINE // READY';
    try { recognition.stop(); } catch(e) {}
  }

  // ==================== TEXT TO SPEECH ====================
  function speakText(text) {
    if (!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    // Clean text dari simbol
    const clean = text.replace(/[‚óÜ‚ñ∂‚ö†‚òÖ‚ú¶‚Ä¢]/g, '').replace(/\*/g, '').trim();
    const utterance = new SpeechSynthesisUtterance(clean);
    utterance.lang = 'id-ID';
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;

    // Coba cari suara Indonesia
    const voices = window.speechSynthesis.getVoices();
    const idVoice = voices.find(v => v.lang.includes('id') || v.lang.includes('ID'));
    if (idVoice) utterance.voice = idVoice;

    isSpeaking = true;
    document.getElementById('statusText').textContent = '‚óè SPEAKING...';
    utterance.onend = () => {
      isSpeaking = false;
      document.getElementById('statusText').textContent = '‚óè ONLINE // READY';
    };
    window.speechSynthesis.speak(utterance);
  }

  function stopSpeak() {
    window.speechSynthesis.cancel();
    isSpeaking = false;
    document.getElementById('statusText').textContent = '‚óè ONLINE // READY';
  }

  // ==================== CRYPTO ====================
  async function fetchTickerPrices() {
    try {
      const ids = 'bitcoin,ethereum,solana,binancecoin,ripple,hyperliquid';
      const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd&include_24hr_change=true`);
      const data = await res.json();
      cryptoData = {...cryptoData, ...data};
      updateTicker(data);
    } catch(e) {}
  }

  function updateTicker(data) {
    const ticker = document.getElementById('cryptoTicker');
    const coins = { bitcoin:'BTC', ethereum:'ETH', solana:'SOL', binancecoin:'BNB', ripple:'XRP', hyperliquid:'HYPE' };
    ticker.innerHTML = '';
    for (const [id, symbol] of Object.entries(coins)) {
      if (!data[id]) continue;
      const price = data[id].usd;
      const change = data[id].usd_24h_change;
      const cls = change >= 0 ? 'up' : 'down';
      const sign = change >= 0 ? '+' : '';
      const priceStr = price >= 1 ? '$' + price.toLocaleString('en-US', {maximumFractionDigits:2}) : '$' + price.toFixed(5);
      ticker.innerHTML += `<div class="ticker-item" onclick="quickAsk('Berapa harga ${symbol} sekarang?')"><span class="ticker-name">${symbol}</span><span class="ticker-price">${priceStr}</span><span class="ticker-change ${cls}">${sign}${change.toFixed(2)}%</span></div>`;
    }
  }

  // Search coin by name/symbol di CoinGecko
  async function searchCoinId(query) {
    try {
      const res = await fetch(`https://api.coingecko.com/api/v3/search?query=${encodeURIComponent(query)}`);
      const data = await res.json();
      if (data.coins && data.coins.length > 0) {
        return data.coins[0].id;
      }
    } catch(e) {}
    return null;
  }

  // Fetch harga berdasarkan coin IDs
  async function fetchCoinPrices(ids) {
    try {
      const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids.join(',')}&vs_currencies=usd&include_24hr_change=true&include_market_cap=true`);
      return await res.json();
    } catch(e) { return null; }
  }

  // Ekstrak kemungkinan nama coin dari teks
  function extractCoinMentions(text) {
    // Hapus kata umum, ambil kata yang mungkin nama token
    const stopWords = ['berapa','harga','sekarang','token','coin','crypto','nilai','info','update','market','pasar','hari','ini','saat','tolong','kasih','tahu','beri','tentang','dan','yang','di','ke','dari','untuk','adalah','ada'];
    const words = text.toLowerCase().replace(/[?!.,]/g, '').split(/\s+/);
    return words.filter(w => w.length >= 2 && !stopWords.includes(w));
  }

  async function resolveCryptoData(text) {
    const mentions = extractCoinMentions(text);
    if (mentions.length === 0) return '';

    // Coba langsung fetch dulu dengan kata kunci
    const directIds = mentions.slice(0, 3);
    let coinData = await fetchCoinPrices(directIds);

    // Filter yang valid
    let validData = {};
    if (coinData) {
      for (const [id, val] of Object.entries(coinData)) {
        if (val.usd) validData[id] = val;
      }
    }

    // Kalau tidak ada hasil, coba search
    if (Object.keys(validData).length === 0) {
      for (const word of mentions.slice(0, 2)) {
        const coinId = await searchCoinId(word);
        if (coinId) {
          const data = await fetchCoinPrices([coinId]);
          if (data && data[coinId] && data[coinId].usd) {
            validData[coinId] = data[coinId];
            break;
          }
        }
      }
    }

    if (Object.keys(validData).length === 0) return '';

    let ctx = '\n\n[DATA CRYPTO REALTIME - ' + new Date().toLocaleString('id-ID') + ']\n';
    for (const [id, info] of Object.entries(validData)) {
      const price = info.usd;
      const change = info.usd_24h_change;
      const mcap = info.usd_market_cap;
      const priceStr = price >= 1 ? '$' + price.toLocaleString('en-US', {maximumFractionDigits:2}) : '$' + price.toFixed(6);
      const mcapStr = mcap ? ` | MCap: $${(mcap/1e9).toFixed(2)}B` : '';
      ctx += `${id}: ${priceStr} (24h: ${change >= 0 ? '+' : ''}${change.toFixed(2)}%)${mcapStr}\n`;
    }
    return ctx;
  }

  // ==================== CHAT ====================
  function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 100) + 'px'; }
  function handleKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
  function quickAsk(text) { document.getElementById('messageInput').value = text; sendMessage(); }

  function addMessage(role, text) {
    const chatArea = document.getElementById('chatArea');
    const div = document.createElement('div');
    div.className = `message ${role}`;

    const label = document.createElement('div');
    label.className = 'message-label';

    if (role === 'ai') {
      label.innerHTML = '‚óÜ OBAN';
      const speakBtn = document.createElement('button');
      speakBtn.className = 'speak-btn';
      speakBtn.textContent = 'üîä';
      speakBtn.title = 'Dengarkan';
      speakBtn.onclick = () => {
        if (isSpeaking) { stopSpeak(); speakBtn.classList.remove('speaking'); }
        else { speakText(text); speakBtn.classList.add('speaking'); setTimeout(() => speakBtn.classList.remove('speaking'), text.length * 60); }
      };
      label.appendChild(speakBtn);
    } else {
      label.textContent = 'USER ‚óÜ';
    }

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.textContent = text;

    div.appendChild(label);
    div.appendChild(bubble);
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
    return div;
  }

  function showTyping(hint) {
    const chatArea = document.getElementById('chatArea');
    const div = document.createElement('div');
    div.id = 'typingIndicator';
    div.className = 'message ai';
    const label = document.createElement('div');
    label.className = 'message-label';
    label.textContent = '‚óÜ OBAN';
    const typing = document.createElement('div');
    typing.className = 'typing';
    typing.innerHTML = '<span></span><span></span><span></span>';
    if (hint) {
      const h = document.createElement('span');
      h.style.cssText = 'font-size:9px;color:rgba(0,255,247,0.4);margin-left:8px;';
      h.textContent = hint;
      typing.appendChild(h);
    }
    div.appendChild(label);
    div.appendChild(typing);
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function removeTyping() { const el = document.getElementById('typingIndicator'); if (el) el.remove(); }

  function isCryptoQuestion(text) {
    const keywords = ['harga','price','berapa','crypto','token','coin','bitcoin','ethereum','btc','eth','market','pasar','naik','turun','chart','trading'];
    return keywords.some(k => text.toLowerCase().includes(k));
  }

  async function sendMessage() {
    alert('send dipanggil');
    if (isLoading) return;
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    input.style.height = 'auto';
    isLoading = true;
    document.getElementById('sendBtn').disabled = true;
    stopSpeak();
    addMessage('user', text);

    let cryptoContext = '';
    if (isCryptoQuestion(text)) {
      showTyping('FETCHING CRYPTO DATA...');
      cryptoContext = await resolveCryptoData(text);
      removeTyping();
    }

    const messageContent = text + cryptoContext;
    conversationHistory.push({ role: 'user', content: messageContent });
    showTyping();

    try {
      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'llama-3.3-70b-versatile',
          messages: [
            { role: 'system', content: 'Kamu adalah OBAN, asisten AI pribadi yang cerdas, ramah, dan informatif. Selalu jawab dalam bahasa Indonesia yang natural. Jika ada data crypto realtime dalam pesan, gunakan data tersebut untuk menjawab dengan akurat. Jawab dengan singkat dan jelas.' },
            ...conversationHistory
          ],
          max_tokens: 1024
        })
      });
      const data = await response.json();
      removeTyping();
      if (data.choices && data.choices[0]) {
        const reply = data.choices[0].message.content;
        conversationHistory.push({ role: 'assistant', content: reply });
        addMessage('ai', reply);
        if (autoSpeak) speakText(reply);
      } else {
        addMessage('ai', '‚ö† ERROR: ' + (data.error?.message || 'Gagal mendapat respons'));
      }
    } catch(err) {
      removeTyping();
      addMessage('ai', '‚ö† CONNECTION ERROR: Periksa koneksi internet Anda.');
    }

    isLoading = false;
    document.getElementById('sendBtn').disabled = false;
    input.focus();
  }

  // Init
  fetchTickerPrices();
  setInterval(fetchTickerPrices, 60000);
  window.speechSynthesis.onvoiceschanged = () => {};

  setTimeout(() => {
    if (apiKey) { initSpeech(); document.getElementById('messageInput').focus(); }
    else document.getElementById('apiKeyInput').focus();
  }, 300);
</script>
</body>
</html>
